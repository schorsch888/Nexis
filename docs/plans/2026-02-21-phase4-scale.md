# Phase 4: Scale 规划（2026-02-21）

## 1. 当前代码库架构分析（As-Is）

### 1.1 系统分层与模块状态
- 后端主干是 Rust workspace（`Cargo.toml`），核心模块：
  - `crates/nexis-gateway`：Control Plane API + WebSocket 路由（当前主要是内存态路由实现）。
  - `crates/nexis-runtime`：AI Provider + Embedding 抽象。
  - `crates/nexis-vector`、`crates/nexis-context`：Phase 3 语义能力基座。
  - `crates/nexis-cli`：REPL + 房间/消息/搜索命令。
- 前端已有 `apps/web`（React + TS + Vite）骨架，但仍偏 MVP/stub。
- 移动端目录尚不存在（`apps/` 下只有 `web`）。

### 1.2 关键现状（影响 Phase 4）
- 数据模型为单租户倾向：`rooms/members/messages` 表暂无 `tenant_id`（`crates/nexis-gateway/migrations/0001_initial.sql`）。
- 鉴权能力未完全接入请求链路：JWT 模块可签发/验签，但 extractor 仍 TODO（`crates/nexis-gateway/src/auth/mod.rs`）。
- 网关业务路由与存储解耦不彻底：`router` 仍使用 in-memory 状态为主（`crates/nexis-gateway/src/router/mod.rs`）。
- 语义链路已有基础，但仍以内网单集群假设为主（尚无 tenant-aware / federated routing）。
- Web UI 可跑通基础页面与 API 调用，但未形成企业级产品面（组织管理、权限、审计、可观测）能力。

### 1.3 Phase 4 的架构结论
- **多租户支持**是全局前置能力（身份、数据库、缓存、日志、向量检索、配额都要带租户上下文）。
- **联邦协议**依赖多租户边界清晰与身份信任体系，不应先于多租户落地。
- **Web UI**可与多租户并行推进，但必须对接新的 tenant-aware API。
- **移动应用**建议在 Web API 稳定后推进，优先复用 Web 的领域模型和 OpenAPI/SDK。

---

## 2. Phase 4 功能复杂度评估

评估维度：架构改动面、跨模块依赖、数据迁移风险、上线风险、测试复杂度。

| 功能 | 复杂度 | 主要原因 | 预计工作量（人周） |
|---|---|---|---|
| 多租户支持 | 高 | 涉及身份、鉴权、DB schema、查询隔离、索引隔离、审计与限流，且有历史数据迁移 | 14-16 |
| 联邦协议 | 很高 | 服务间信任、签名验签、事件复制、冲突处理、一致性与回放、跨域故障恢复 | 16-18 |
| Web UI | 中高 | 现有骨架可复用，但缺企业核心页面、状态管理、权限控制、实时协作体验与测试体系 | 9-11 |
| 移动应用 | 高 | 从 0 到 1，需新工程、鉴权、安全存储、消息同步、离线与推送策略 | 10-12 |

**总量预估：49-57 人周**（含开发、测试、文档、发布准备，不含大规模生产事故缓冲）。

---

## 3. 优先级排序后的 Task 列表

### P0（先做，决定 Phase 4 成败）

1. `T01` 多租户域模型与 ID 规范（tenant/workspace/member/room 关系）
- 输出：统一租户边界定义、跨模块实体映射、错误码规范。
- 估算：1 人周。

2. `T02` Tenant-aware 鉴权与授权链路
- 输出：JWT claims 引入 `tenant_id`、request context 注入、跨租户访问默认拒绝。
- 估算：2 人周。

3. `T03` 数据层改造与迁移
- 输出：`tenant_id` 加入核心表与索引，迁移脚本、回填脚本、回滚策略。
- 估算：3 人周。

4. `T04` 租户隔离测试与安全基线
- 输出：跨租户渗透测试用例、RLS/查询守卫、审计日志字段补齐。
- 估算：2 人周。

5. `T05` Web API v1 稳定化（供 Web/Mobile 复用）
- 输出：tenant-aware REST/WebSocket 契约、错误码、分页/过滤统一。
- 估算：2 人周。

### P1（第二波，形成可交付产品）

6. `T06` Web UI 核心 IA 与设计系统落地
- 输出：组织切换、房间列表、消息流、成员管理、基础搜索。
- 估算：2 人周。

7. `T07` Web UI 鉴权与会话管理
- 输出：登录、token 刷新、权限门禁、租户上下文切换。
- 估算：1.5 人周。

8. `T08` Web UI 实时协作能力
- 输出：WebSocket 连接管理、消息状态（sent/delivered/read）、错误恢复。
- 估算：2 人周。

9. `T09` 联邦协议 v0（最小互通）
- 输出：Server-to-Server 握手、签名、远端 room discovery、单向消息转发。
- 估算：4 人周。

10. `T10` 联邦事件模型与重试机制
- 输出：事件幂等键、重放窗口、死信队列、观测指标。
- 估算：3 人周。

11. `T11` 联邦安全策略
- 输出：信任域白名单、密钥轮换、限流与滥用防护。
- 估算：2 人周。

### P2（第三波，扩展与发布质量）

12. `T12` 移动端工程初始化（React Native/Expo）
- 输出：应用骨架、导航、状态管理、API SDK。
- 估算：2 人周。

13. `T13` 移动端核心功能（房间/消息/搜索）
- 输出：消息列表、发送、拉取历史、基础语义搜索。
- 估算：3 人周。

14. `T14` 移动端安全与离线能力
- 输出：安全存储、token 生命周期、离线队列与重连。
- 估算：2.5 人周。

15. `T15` 移动端推送与通知
- 输出：推送通道抽象、未读状态同步。
- 估算：1.5 人周。

16. `T16` 可观测性与发布准备
- 输出：多租户维度监控、SLO、联邦链路告警、灰度发布清单。
- 估算：2 人周。

---

## 4. 工时估算与里程碑（Phase 4: 2026-08 ~ 2026-10）

### 4.1 资源假设
- 团队规模：4 名工程师（后端 2、前端 1、移动 1，可动态支援）。
- 产能按 12 周（6 个两周 Sprint）估算：约 **48 人周**。
- 与总工作量（49-57 人周）相比：需要严格控 scope（移动端先 Beta）。

### 4.2 里程碑计划（具体日期）

1. **M4.1 多租户基础完成**（2026-08-03 ~ 2026-08-28）
- 完成：`T01-T04`。
- 交付：后端 tenant-aware、核心隔离测试通过。

2. **M4.2 Web 可用版（Internal Beta）**（2026-08-31 ~ 2026-09-25）
- 完成：`T05-T08`。
- 交付：Web 完整主流程（登录、房间、消息、搜索）可用于内部团队。

3. **M4.3 联邦 MVP**（2026-09-28 ~ 2026-10-16）
- 完成：`T09-T11`。
- 交付：双集群互通、签名校验、基础重试可用。

4. **M4.4 移动 Beta + 发布就绪**（2026-10-19 ~ 2026-10-30）
- 完成：`T12-T16` 的 Beta 范围（优先 `T12-T14+T16`，`T15` 可按风险降级）。
- 交付：移动端 Beta、全链路监控与发布清单。

### 4.3 关键路径
- **关键路径 A：`T01 -> T02 -> T03 -> T04 -> T05`**（决定所有客户端是否可并行）。
- **关键路径 B：`T09 -> T10 -> T11`**（决定联邦是否可上线）。
- **关键路径 C：`T12 -> T13 -> T14`**（决定移动端是否达到 Beta）。

### 4.4 风险与缓冲
- 风险 1：多租户迁移窗口过大，导致发布阻塞。
- 风险 2：联邦协议边界不清，返工概率高。
- 风险 3：移动端与后端契约变动频繁，联调成本高。
- 建议：保留 10-15% 机动容量（约 5-7 人周）作为风险缓冲。

---

## 5. 执行建议（落地顺序）

1. 先固化 `Tenant Context`（协议、DB、网关链路）再推进 UI。  
2. 联邦协议先做 MVP（点对点 + 幂等 + 签名），不在 Phase 4 内追求全拓扑。  
3. 移动端以 Beta 为目标：优先消息主链路，推送可作为可降级项。  
4. 每个里程碑设置“可演示、可回滚、可监控”三个硬门槛。

